---
title: "Coverage control"
author: "AG"
date: "`r Sys.Date()`"
format:
  html:
    toc: true
    toc_float: true
    theme: solar
    embed-resources: true
    code-fold: true
    code-summary: "show code"
    df-print: kable
    cap-location: top
    self-contained: true
    standalone: true
editor: visual
---

## Intro

Here I will check coverage and proportion of reads that exceed the length threshold (3577 bp) and containing:

1.  a region approx. 500 bp downstream the DS (CR4, pos. 31071 + 500 + 1677)
2.  a region exactly opposite of the DS (CR1, pos. 87000 + 1677)
3.  a region between the DS and the opposite end (clockwise) (CR3, pos. 60000 - 1677)
4.  a region between the DS and the opposite end (anti-clockwise) (CR2, pos. 5000 + 1677)

Our hypothesis is that coverage upstream the DS is higher than in the three remote regions (?)

![Fig.1. Plasmid DA61218 and the location of control regions](figures/pDA61218_full_size_annotated.png)

Sequences of the regions CR1 - CR4 are in `resources/control_regions`

All control regions (CR) were blasted against each samples' reads.
See `workflow/covcontrol.smk` for details.

## Overview of BLAST results:

The blast tables look like this:

```{r}
#| message: false
library(tidyverse)

blast_cr <- read_tsv("../results/cc/coverage_control_table.tsv", col_names = c('control_region', 'read_ID', 'identity', 'length', 'mismatch', 'gaps', 'qstart', 'qend', 'sstart', 'send', 'e_value', 'bit_score', 'sample'), skip = 1)

blast_cr %>% 
  head(n = 10) %>% 
  knitr::kable()
```

### Identity

```{r}
ggplot(blast_cr, aes(control_region, identity)) +
  geom_boxplot(alpha = 1, outliers = F) +
  geom_violin(aes(fill = control_region), alpha=0.2) +
  facet_grid(rows = vars(sample)) +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_brewer(palette = "Set2") +
  labs(x = "", y = "identity, %") +
  ggtitle("Identity of hits") +
  geom_hline(yintercept = 80, color = "red", linetype="dashed")
```

### Length

```{r}
ggplot(blast_cr, aes(control_region, length)) +
  geom_boxplot(alpha = 1, outliers = F) +
  geom_violin(aes(fill = control_region), alpha=0.2) +
  facet_grid(rows = vars(sample)) +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_brewer(palette = "Set2") +
  labs(x = "", y = "length, nt") +
  ggtitle("Length of hits") +
  geom_hline(yintercept = 1500, color = "red", linetype="dashed")
```

## Number of reads containing each CR

### Bar plot

hits shorter than 1500 and less 80% identity have been removed

```{r}
blast_cr %>% 
  filter(length >= 1500,
         identity >= 80) %>% 
  select(sample, control_region, read_ID) %>% 
  distinct() %>% 
  dplyr::group_by(sample, control_region) %>% 
  dplyr::count() %>% 
  ggplot(aes(control_region, n)) +
  geom_col(aes(fill = control_region), alpha = 0.7) +
  facet_grid(rows = vars(sample)) +
  xlab("") +
  ylab("coverage") +
  scale_fill_brewer(palette = "Set2") +
  theme_minimal() +
  theme(legend.position = "none") +
  ggtitle("Read coverage")
  
```

### Table of read counts per sample and region:

hits shorter than 1500 and less 80% identity have been removed

```{r}
blast_cr %>% 
  filter(length >= 1500,
         identity >= 80) %>% 
  select(sample, control_region, read_ID) %>% 
  distinct() %>% 
  dplyr::group_by(sample, control_region) %>% 
  dplyr::count() %>% 
  knitr::kable()
```

