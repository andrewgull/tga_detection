---
title: "CNV plots"
author: "AG"
date: "`r Sys.Date()`"
format:
  html:
    toc: true
    toc_float: true
    theme: cyborg
    embed-resources: true
    code-fold: true
    code-summary: "show code"
    df-print: kable
    cap-location: top
---

## Data

```{r, message=FALSE}
library(purrr)
library(readr)
library(dplyr)
library(stringr)
library(ggplot2)

config <- yaml::read_yaml("../workflow/config.yaml")
samples <- unlist(config$samples)

read_many_tables <- function(table_name) {
  out_df <- map_dfr(samples, function(x) {
    df <-
      read_tsv(paste0("../results/tables/", x, "/", table_name),
               show_col_types = F)
    df$sample <- x
    return(df)
  }) %>%
    mutate(replicate = str_split_i(sample, "_", i = 2),
           group = str_split_i(sample, "_", i = 3))
  
  return(out_df)
}

res_df <- read_many_tables("blaSHV_counts.tsv")
freq_df <- read_many_tables("frequencies.tsv") %>% 
  # add limits of detection
  mutate(detection_limit = 1/n.reads)

# save the table for Sofia
write_delim(freq_df %>% select(CN, reads_freq_adj, detection_limit, group, sample), file = "../results/tables/frequencies_all.tsv")
```


```{r}
#| tbl-cap: "N reads per sample"

knitr::kable(freq_df)
```


```{r, fig.width=10, fig.height=6}
res_df %>% 
  group_by(sample) %>% 
  count() %>% 
  ggplot(aes(reorder(sample, -n), n)) +
  geom_col(fill="steelblue") +
  #coord_trans(y = "sqrt") +
  theme(axis.text.x = element_text(size=10, angle=45, hjust = 1)) +
  ggtitle("Reads per sample") +
  ylab("n reads") +
  xlab("") +
  theme_bw()
```


## CNV frequency plots

### MH + selection

```{r, fig.height=8, warning=FALSE}
freq_df %>%
  filter(grepl("x", group) | grepl("mh", group)) %>% 
  ggplot(aes(CN, reads_freq_adj)) +
  geom_col(aes(fill=group)) +
  geom_rug(sides = "b", length = unit(0.06, "npc")) +
  scale_x_continuous(breaks = c(0:19)) +
  facet_grid(rows = vars(group)) +
  xlab("copy number") +
  ylab("log10 adjusted frequency") +
  theme_bw() +
  theme(legend.position = "none")
```


### Reversion

```{r,fig.height=8, warning=FALSE}
freq_df %>%
  filter(grepl("g", group)) %>% 
  mutate(group = ordered(group, levels = c("10g", "20g", "40g", "80g", "160g"))) %>% 
  ggplot(aes(CN, reads_freq_adj)) +
  geom_col(aes(fill=group)) +
  geom_rug(sides = "b", length = unit(0.06, "npc")) +
  scale_x_continuous(breaks = c(0:17)) +
  facet_grid(rows = vars(group)) +
  xlab("copy number") +
  ylab("log10 adjusted frequency") +
  theme_bw() +
  theme(legend.position = "none")
```

### With detection limit line

```{r,fig.height=8}
freq_df %>%
  filter(group == "mh") %>% 
  #mutate(group = ordered(group, levels = c("10g", "20g", "40g", "80g", "160g"))) %>% 
  #filter(CN < 4, CN != 0) %>% 
  ggplot(aes(CN, 6+log10(reads_freq_adj))) +
  geom_col() +
  geom_line(aes(CN, 6+log10(detection_limit)), color = "red", linewidth=5)
```

### CN change across groups

```{r,fig.height=8}
freq_df %>%
  filter(grepl("g", group), CN == 4) %>% 
  mutate(group = ordered(group, levels = c("10g", "20g", "40g", "80g", "160g"))) %>% 
  ggplot(aes(group, reads_freq_adj)) +
  geom_col(fill = "#B1676D")+
  #facet_grid(rows = vars(CN)) +
  scale_fill_brewer(palette = "Set2") +
  theme_bw() +
  ggtitle("CN = 4") +
  xlab("") +
  ylab("adjusted frequency")
```


