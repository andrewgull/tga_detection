---
title: "Coverage control"
author: "AG"
date: "`r Sys.Date()`"
format:
  html:
    toc: true
    toc_float: true
    theme: solar
    embed-resources: true
    code-fold: true
    code-summary: "show code"
    df-print: kable
    cap-location: top
    self-contained: true
    standalone: true
editor: visual
---

## Intro

Here I will check coverage of the five *control regions* - for exact coordinates and other details see `configs/covcontrol.smk`

Length of each control region is 500 nt

Our hypothesis is that coverage of the regions close to the DS (CR4 & CR5) is higher than in the three remote regions

![Fig.1. Plasmid DA61218 and the location of control regions](figures/plasmid_full_map.png)

All control regions (CR) were blasted against each samples' reads. 

See `configs/covcontrol.smk` for details.

## Overview of BLAST results:

The blast tables look like this:

```{r}
#| message: false
library(tidyverse)

blast_cr <- read_tsv("../../results/cc/coverage_control_table.tsv", 
                     col_names = c('control_region', 'read_ID', 'identity', 
                                   'length', 'mismatch', 'gaps', 'qstart', 
                                   'qend', 'sstart', 'send', 'e_value', 
                                   'bit_score', 'sample'), 
                     skip = 1)

blast_cr %>% 
  head(n = 10) %>% 
  knitr::kable()
```

### Identity

```{r}
ggplot(blast_cr, aes(control_region, identity)) +
  geom_boxplot(alpha = 1, outliers = F) +
  geom_violin(aes(fill = control_region), alpha=0.2) +
  facet_grid(rows = vars(sample)) +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_brewer(palette = "Set2") +
  labs(x = "", y = "identity, %") +
  ggtitle("Identity of hits") +
  geom_hline(yintercept = 80, color = "red", linetype="dashed")
```

### Length

```{r}
ggplot(blast_cr, aes(control_region, length)) +
  geom_boxplot(alpha = 1, outliers = F) +
  geom_violin(aes(fill = control_region), alpha=0.2) +
  facet_grid(rows = vars(sample)) +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_fill_brewer(palette = "Set2") +
  labs(x = "", y = "length, nt") +
  ggtitle("Length of hits")
```

## Number of reads containing each CR

### Bar plot

```{r}
blast_cr %>% 
  select(sample, control_region, read_ID) %>% 
  distinct() %>% 
  dplyr::group_by(sample, control_region) %>% 
  dplyr::count() %>% 
  ggplot(aes(control_region, n)) +
  geom_col(aes(fill = control_region), alpha = 0.7) +
  facet_grid(rows = vars(sample)) +
  xlab("") +
  ylab("coverage") +
  scale_fill_brewer(palette = "Set2") +
  theme_minimal() +
  theme(legend.position = "none") +
  ggtitle("Read coverage")
  
```

### Table of read counts per sample and region:

```{r}
blast_cr %>% 
  select(sample, control_region, read_ID) %>% 
  distinct() %>% 
  dplyr::group_by(sample, control_region) %>% 
  dplyr::count() %>% 
  knitr::kable()
```
